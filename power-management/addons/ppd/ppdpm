#!/bin/bash
#script to look for presence of file in /tmp/ generated by a udev rule. This then causes ppd to apply a certain profile
#assign your username in the following line:
USERNAME=
## Polling is expensive. Let us use inotify.
inotifywait --monitor --format "%e %w%f" --event modify,create /tmp/pmtoggle | while read changed; do
    ## If the tmp file has value 0, that means that there is no AC attached
    if [ ! -z "$(tail -n2 /tmp/pmtoggle | grep '0')" ]; then
        powerprofilesctl set power-saver #tuned's powersave profile
        echo "1" | tee /sys/devices/system/cpu/intel_pstate/no_turbo #turn off turbo boost
        su - $USERNAME -c "gsettings set org.gnome.desktop.interface enable-animations false"
        echo "AC not attached. Entering powersave mode..."

    ## Else, if the tmp file has value 1, that means there is AC attached
    else
        powerprofilesctl set performance #tuned's throughput-performance profile
        echo "0" | tee /sys/devices/system/cpu/intel_pstate/no_turbo #turn on turbo boost
        su - $USERNAME -c "gsettings set org.gnome.desktop.interface enable-animations true"
        echo "AC attached. Entering performance mode..."
    fi
done
