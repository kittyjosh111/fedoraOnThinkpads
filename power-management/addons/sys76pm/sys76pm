#!/bin/bash
#script to look for presence of file in /tmp/ generated by a udev rule. This then causes tuned-adm to apply a certain profile
USERNAME=$(who | grep "\(${_display_id}\)" | awk '{print $1}' | head -n 1)

#if this be first boot, first check the AC status manually
pmtoggle

## Polling is expensive. Let us use inotify.
function toggler() {
    inotifywait --monitor --format "%e %w%f" --event modify,create /tmp/pmtoggle | while read changed; do
        ## If the tmp file has value 0, that means that there is no AC attached
        if [ ! -z "$(tail -n2 /tmp/pmtoggle | grep '0')" ]; then
            system76-power profile battery
            $1
            echo "AC not attached. Entering powersave mode..."

        ## Else, if the tmp file has value 1, that means there is AC attached
        else
            system76-power profile performance
            $2
            echo "AC attached. Entering performance mode..."
        fi
    done
}

if ! [[ -z "$(ls /usr/bin/*-session | grep gnome)" ]]; then
  echo "Running on gnome..."
  ## Following function adapted from https://stackoverflow.com/questions/20292578/setting-gsettings-of-other-user-with-sudo
  function runas() {
      display_id=":$(find /tmp/.X11-unix/* | sed 's#/tmp/.X11-unix/X##' | head -n 1)"
      user_id=$(id -u "$USERNAME")
      environment=("DISPLAY=$display_id" "DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$user_id/bus")
      sudo -Hu "$USERNAME" env "${environment[@]}" "$@"
  }
  toggler "runas gsettings set org.gnome.desktop.interface enable-animations false" "runas gsettings set org.gnome.desktop.interface enable-animations true"
else
  echo "Not running on gnome..."
  toggler
fi
